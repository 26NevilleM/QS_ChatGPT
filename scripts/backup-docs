#!/bin/sh
set -e

DOCS_DIR="${DOCS_DIR:-.}"

if [ "${1:-}" = "--prune-only" ]; then
  echo "[PRUNE] Only pruning old backups (keeping 10 newest)..."
else
  ts="$(date +%Y-%m-%d_%H-%M-%S)"
  zipfile="$HOME/Downloads/qs_docs_backup_${ts}.zip"

  # Collect files that actually exist
  files=""
  for f in "$DOCS_DIR/README.md" "$DOCS_DIR/CONTRIBUTING.md" "$DOCS_DIR/CHANGELOG.md"; do
    [ -f "$f" ] && files="$files $f"
  done

  if [ -n "$files" ]; then
    # SC2086 intentional: we want $files to expand into separate paths
    zip -qr "$zipfile" $files
    echo "[OK] Backup created: $zipfile"
  else
    echo "[SKIP] No docs found in '$DOCS_DIR'; skipping backup."
    # Just in case: ensure we didn't leave an empty file lying around
    rm -f "$zipfile" 2>/dev/null || true
  fi
fi

# --- Prune old backups: keep the 10 newest (portable) ---
count=0
ls -1t "$HOME"/Downloads/qs_docs_backup_*.zip 2>/dev/null | while IFS= read -r f; do
  count=$((count+1))
  if [ "$count" -gt 10 ]; then
    rm -f -- "$f"
  fi
done
# --- end prune block ---
